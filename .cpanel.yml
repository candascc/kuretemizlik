---
# cPanel Deployment Configuration
# This file defines how cPanel should deploy your application
# Documentation: https://docs.cpanel.net/knowledge-base/web-services/guide-to-git-set-up-deployment/
#
# Repository Path: /home/cagdasya/repositories/kuretemizlik
# Deployment Path: /home/cagdasya/kuretemizlik.com/app

deployment:
  tasks:
    # Set deployment path
    # CPANEL_USER will be automatically replaced with 'cagdasya'
    # Final path: /home/cagdasya/kuretemizlik.com/app
    - export DEPLOYPATH=/home/$${CPANEL_USER}/kuretemizlik.com/app
    
    # Backup current deployment (optional but recommended)
    - /bin/mkdir -p $${DEPLOYPATH}/../backups
    - /bin/tar -czf $${DEPLOYPATH}/../backups/backup-$$(date +%Y%m%d-%H%M%S).tar.gz -C $${DEPLOYPATH} . 2>/dev/null || true
    
    # Copy all files to deployment path
    - /bin/cp -R * $${DEPLOYPATH}/
    
    # Set proper permissions for directories
    - /bin/find $${DEPLOYPATH} -type d -exec chmod 755 {} \;
    
    # Set proper permissions for files
    - /bin/find $${DEPLOYPATH} -type f -exec chmod 644 {} \;
    
    # Make PHP files executable
    - /bin/chmod 755 $${DEPLOYPATH}/index.php 2>/dev/null || true
    
    # Set write permissions for specific directories (required for app to work)
    - /bin/chmod 775 $${DEPLOYPATH}/db 2>/dev/null || true
    - /bin/chmod 775 $${DEPLOYPATH}/logs 2>/dev/null || true
    - /bin/chmod 775 $${DEPLOYPATH}/cache 2>/dev/null || true
    - /bin/chmod 775 $${DEPLOYPATH}/uploads 2>/dev/null || true
    
    # Protect sensitive files (.env, config files)
    - /bin/chmod 600 $${DEPLOYPATH}/.env 2>/dev/null || true
    - /bin/chmod 600 $${DEPLOYPATH}/env.production 2>/dev/null || true
    - /bin/chmod 600 $${DEPLOYPATH}/env.local 2>/dev/null || true
    
    # Note: .env file is not in git, you need to create it manually in production
    # Copy env.production.example to .env and configure it
    
    # Clean up temporary files
    - /bin/rm -rf $${DEPLOYPATH}/.git
    - /bin/rm -rf $${DEPLOYPATH}/test-results
    - /bin/rm -rf $${DEPLOYPATH}/tests/_output
    - /bin/rm -rf $${DEPLOYPATH}/node_modules/.cache
    
    # Run Composer install (if vendor directory is not in git)
    - cd $${DEPLOYPATH} && /usr/local/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction 2>/dev/null || true
    
    # Clear cache
    - /bin/rm -rf $${DEPLOYPATH}/cache/* 2>/dev/null || true
    
    # Log deployment
    - echo "Deployment completed at $$(date)" >> $${DEPLOYPATH}/../deployment.log

