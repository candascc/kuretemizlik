name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  phpstan:
    name: PHPStan Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring, pdo, pdo_sqlite, sqlite3
          coverage: none
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Run PHPStan
        run: composer stan || true
        continue-on-error: true

  php-cs-fixer:
    name: PHP-CS-Fixer Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring
          coverage: none
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Run PHP-CS-Fixer check
        run: composer cs-check || true
        continue-on-error: true

  tests:
    name: PHPUnit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1']
        test-suite: ['Fast', 'Slow']
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, pdo, pdo_sqlite, sqlite3, xdebug
          coverage: xdebug
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Run ${{ matrix.test-suite }} tests
        run: php vendor/bin/phpunit --testsuite=${{ matrix.test-suite }} --configuration phpunit.xml
      
      - name: Generate coverage
        if: matrix.test-suite == 'Fast'
        run: php vendor/bin/phpunit --testsuite=Fast --configuration phpunit.xml --coverage-clover=coverage.xml --coverage-html=tests/coverage || true
        continue-on-error: true
      
      - name: Upload coverage to Codecov
        if: matrix.test-suite == 'Fast' && matrix.php-version == '7.4'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  all-tests:
    name: All Tests
    runs-on: ubuntu-latest
    needs: [phpstan, php-cs-fixer, tests]
    if: always()
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring, pdo, pdo_sqlite, sqlite3
          coverage: none
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Run all tests
        run: php vendor/bin/phpunit --configuration phpunit.xml --testsuite=All
